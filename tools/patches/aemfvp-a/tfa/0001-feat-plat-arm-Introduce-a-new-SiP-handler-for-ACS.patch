From 30a918d51388ab3bb8474d200392427fafe4e260 Mon Sep 17 00:00:00 2001
From: Nandan J <Nandan.J@arm.com>
Date: Fri, 1 Dec 2023 19:53:12 +0530
Subject: [PATCH 1/2] feat(plat/arm): Introduce a new SiP handler for ACS

In preparation to add support for the Architecture Compliance Suite
SMC services, reserve a SMC ID and introduce a handler function.
Currently, an empty placeholder function is added and future support
will be introduced for the handler support.

Change-Id: I2b72d40d04c64a92df6deb409dc01d29192f1ac0
Signed-off-by: Nandan J <Nandan.J@arm.com>
---
 include/plat/arm/common/plat_acs_smc_handler.h | 18 ++++++++++++++++++
 plat/arm/common/arm_common.mk                  |  4 ++++
 plat/arm/common/arm_sip_svc.c                  | 15 +++++++++++++++
 plat/arm/common/plat_acs_smc_handler.c         | 18 ++++++++++++++++++
 4 files changed, 55 insertions(+)
 create mode 100644 include/plat/arm/common/plat_acs_smc_handler.h
 create mode 100644 plat/arm/common/plat_acs_smc_handler.c

diff --git a/include/plat/arm/common/plat_acs_smc_handler.h b/include/plat/arm/common/plat_acs_smc_handler.h
new file mode 100644
index 000000000..2337a9e82
--- /dev/null
+++ b/include/plat/arm/common/plat_acs_smc_handler.h
@@ -0,0 +1,18 @@
+/*
+ * Copyright (c) 2023, Arm Limited and Contributors. All rights reserved.
+ *
+ * SPDX-License-Identifier: BSD-3-Clause
+ */
+
+#ifndef ACS_SMC_HANDLER_H
+#define ACS_SMC_HANDLER_H
+
+#include <lib/utils_def.h>
+
+/* ARM ACS SMC service call */
+#define ARM_SIP_ACS_SMC_HANDLER     U(0xC2000060)
+
+uintptr_t plat_arm_acs_smc_handler(uint64_t services, uint64_t arg0,
+                                   uint64_t arg1, uint64_t arg2);
+
+#endif /* ACS_SMC_HANDLER_H */
diff --git a/plat/arm/common/arm_common.mk b/plat/arm/common/arm_common.mk
index f5919ab5e..0b7bb45c0 100644
--- a/plat/arm/common/arm_common.mk
+++ b/plat/arm/common/arm_common.mk
@@ -323,6 +323,10 @@ BL31_SOURCES		+=	plat/arm/common/aarch64/execution_state_switch.c\
 				plat/arm/common/arm_sip_svc.c			\
 				plat/arm/common/plat_arm_sip_svc.c		\
 				${ARM_SVC_HANDLER_SRCS}
+ifeq (${PLAT_ARM_ACS_SMC_HANDLER},1)
+BL31_SOURCES		+=	plat/arm/common/plat_acs_smc_handler.c
+endif
+
 else
 BL32_SOURCES		+=	plat/arm/common/arm_sip_svc.c			\
 				plat/arm/common/plat_arm_sip_svc.c		\
diff --git a/plat/arm/common/arm_sip_svc.c b/plat/arm/common/arm_sip_svc.c
index 18e9381ae..536ed7ca5 100644
--- a/plat/arm/common/arm_sip_svc.c
+++ b/plat/arm/common/arm_sip_svc.c
@@ -13,6 +13,12 @@
 #include <lib/pmf/pmf.h>
 #include <plat/arm/common/arm_sip_svc.h>
 #include <plat/arm/common/plat_arm.h>
+#if PLAT_ARM_ACS_SMC_HANDLER
+#include <plat/arm/common/plat_acs_smc_handler.h>
+#endif /* PLAT_ARM_ACS_SMC_HANDLER */
+#if ENABLE_SPMD_LP
+#include <services/el3_spmd_logical_sp.h>
+#endif
 #include <tools_share/uuid.h>
 
 /* ARM SiP Service UUID */
@@ -61,6 +67,15 @@ static uintptr_t arm_sip_handler(unsigned int smc_fid,
 {
 	int call_count = 0;
 
+#if PLAT_ARM_ACS_SMC_HANDLER
+	/*
+	 * Placeholder function for ACS User SMC calls
+	 */
+	if (smc_fid == ARM_SIP_ACS_SMC_HANDLER) {
+	    return plat_arm_acs_user_smc_handler(x1, x2, x3, x4);
+	}
+#endif /* PLAT_ARM_ACS_SMC_HANDLER */
+
 #if ENABLE_PMF
 	/*
 	 * Dispatch PMF calls to PMF SMC handler and return its return
diff --git a/plat/arm/common/plat_acs_smc_handler.c b/plat/arm/common/plat_acs_smc_handler.c
new file mode 100644
index 000000000..290fa6599
--- /dev/null
+++ b/plat/arm/common/plat_acs_smc_handler.c
@@ -0,0 +1,18 @@
+/*
+ * Copyright (c) 2023, ARM Limited and Contributors. All rights reserved.
+ *
+ * SPDX-License-Identifier: BSD-3-Clause
+ */
+#include <stdint.h>
+#include <plat/arm/common/plat_acs_smc_handler.h>
+
+#if PLAT_ARM_ACS_SMC_HANDLER
+/*
+ * Placeholder function for ACS SMC call
+ */
+uintptr_t plat_arm_acs_smc_handler(uint64_t services, uint64_t arg0,
+                 uint64_t arg1, uint64_t arg2)
+{
+	return 0;
+}
+#endif /* PLAT_ARM_ACS_SMC_HANDLER */
-- 
2.34.1

